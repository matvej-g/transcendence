networks:
  transcendence:
    name: transcendence

volumes:
  sqlite_data:
    name: database
  avatars:
    name: avatars
  vendor:
    name: vendor
  # volume_frontend:
  #   name: frontend

services:
  php-backend:
    container_name: php-backend
    build: ./backend
    restart: on-failure
    dns:
      - 8.8.8.8
      - 8.8.4.4
    volumes:
      - ./backend:/var/www/html
      - ./backend/.env:/var/www/html/.env
      - vendor:/var/www/html/vendor  # Exclude vendor from mount
      - sqlite_data:/var/www/html/database
      - avatars:/var/www/html/uploads/avatars
    env_file:
      - ./backend/.env
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    networks: 
      - transcendence
    healthcheck:
      test: ["CMD-SHELL", "php-fpm -t >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
  frontend:
    container_name: frontend
    build: ./frontend
    restart: on-failure
    volumes: 
      - ./frontend:/var/www/html
    networks: 
      - transcendence
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost/ > /dev/null || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
  websocket:
    container_name: websocket
    build:
      context: .
      dockerfile: websocket/Dockerfile
    depends_on:
      php-backend:
        condition: service_healthy
    ports:
      - "8081:8080"
    volumes:
      - sqlite_data:/var/www/html/database
    networks:
      - transcendence
  redis:
    container_name: redis
    image: "redis:7-alpine"
    restart: on-failure
    # ports:
      # - "6379:6379"
    networks:
      - transcendence
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
  ws_app:
    container_name: ws_app
    build:
      context: .
      dockerfile: websocket_app/Dockerfile
    restart: on-failure
    networks:
      - transcendence
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      redis:
        condition: service_healthy
  nginx:
    container_name: nginx
    build: ./nginx
    restart: on-failure
    ports:
      - "8080:80"
      - "443:443"
    volumes:
      - ./backend/public:/var/www/html/public
      - avatars:/var/www/html/uploads/avatars:ro
    depends_on:
      - php-backend
      - frontend
      - websocket
      - ws_app
    networks:
      - transcendence
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost/ > /dev/null || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
