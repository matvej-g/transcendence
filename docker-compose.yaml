networks:
  transcendence:
    name: transcendence

volumes:
  sqlite_data:
    name: database
  avatars:
    name: avatars
  vendor:
    name: vendor
  # volume_frontend:
  #   name: frontend

services:
  php-backend:
    container_name: php-backend
    build: ./backend
    restart: on-failure
    dns:
      - 8.8.8.8
      - 8.8.4.4
    volumes:
      - ./backend:/var/www/html
      - ./backend/.env:/var/www/html/.env
      - vendor:/var/www/html/vendor  # Exclude vendor from mount
      - sqlite_data:/var/www/html/database
      - avatars:/var/www/html/uploads/avatars
    env_file:
      - ./backend/.env
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    networks: 
      - transcendence
    healthcheck:
      test: ["CMD-SHELL", "php-fpm -t >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
  frontend:
    container_name: frontend
    build: ./frontend
    restart: on-failure
    volumes: 
      - ./frontend:/var/www/html
    networks: 
      - transcendence
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost/ > /dev/null || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
  websocket:
    container_name: websocket
    build:
      context: .
      dockerfile: websocket/Dockerfile
    depends_on:
      php-backend:
        condition: service_healthy
    ports:
      - "8081:8080"
    volumes:
      - sqlite_data:/var/www/html/database
    networks:
      - transcendence
  redis:
    container_name: redis
    image: "redis:7-alpine"
    restart: on-failure
    # ports:
      # - "6379:6379"
    networks:
      - transcendence
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
  ws_app:
    container_name: ws_app
    build:
      context: .
      dockerfile: websocket_app/Dockerfile
    restart: on-failure
    networks:
      - transcendence
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      redis:
        condition: service_healthy
  nginx:
    container_name: nginx
    build: ./nginx
    restart: on-failure
    ports:
      - "8080:80"
      - "8443:443"
    volumes:
      - ./backend/public:/var/www/html/public
      - avatars:/var/www/html/uploads/avatars:ro
    depends_on:
      - php-backend
      - frontend
      - websocket
      - ws_app
    networks:
      - transcendence
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost/ > /dev/null || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  cloudflared:
    container_name: cloudflared
    image: cloudflare/cloudflared:2025.11.1
    command: tunnel --config /etc/cloudflared/config.yaml run
    restart: unless-stopped
    volumes:
      - ./cloudflared:/etc/cloudflared:ro
    networks:
      - transcendence
    depends_on:
      nginx:
        condition: service_started
      cloudflared-precheck:
        condition: service_completed_successfully

  cloudflared-precheck:
    image: busybox:1.36
    container_name: cloudflared-precheck
    volumes:
      - ./cloudflared:/etc/cloudflared:ro
    command:
      [
        "sh",
        "-lc",
        "for i in $(seq 1 12); do \
          test -s /etc/cloudflared/config.yaml \
          -a -s /etc/cloudflared/cert.pem \
          -a -s /etc/cloudflared/*.json && exit 0; \
          sleep 5; \
        done; \
        echo 'cloudflare credentials missing'; \
        exit 1"
      ]
    restart: "no"

